%% Enhanced ai-roles-workflows-comprehensive_diagram_4.mmd with better fonts and colors
%% Generated by enhance_mermaid_diagrams.py

graph TD
classDef primary fill:#e8f4fd,stroke:#1976d2,stroke-width:3px,color:#0d47a1,font-size:14px,font-weight:bold
classDef secondary fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px,color:#4a148c,font-size:13px,font-weight:bold
classDef success fill:#e8f5e8,stroke:#388e3c,stroke-width:3px,color:#1b5e20,font-size:13px,font-weight:bold
classDef warning fill:#fff3e0,stroke:#f57c00,stroke-width:3px,color:#e65100,font-size:13px,font-weight:bold
classDef danger fill:#ffebee,stroke:#c62828,stroke-width:3px,color:#b71c1c,font-size:13px,font-weight:bold
classDef info fill:#e0f2f1,stroke:#00695c,stroke-width:3px,color:#004d40,font-size:13px,font-weight:bold
classDef light fill:#fff8e1,stroke:#fbc02d,stroke-width:3px,color:#f57f17,font-size:13px,font-weight:bold
    
    U["👤 User Query"]:::input --> N["Normalize + Session"]:::process
    N --> SEC["🔒 Security Scan"]:::security
    SEC --> RET["Retrieve Top-k"]:::process
    RET --> RERANK["Re-rank"]:::process
    RERANK --> COMP["Compose Prompt + Citations"]:::process
    COMP --> LLM["Generate stream"]:::process
    LLM --> OUT["🏁 Render Answer + Sources"]:::output
    OUT --> LOG["Log + Metrics"]:::process
    LOG --> EVAL["Auto Eval: groundedness/hallucinations"]:::process
    LOG --> CACHE["Cache Response"]:::process
    LOG --> COST["💰 Cost Tracking"]:::process